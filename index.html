<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>えんえんトンネル 延長距離シミュレーター</title>


<style>
  body{font-family:sans-serif;background:#0f1724;color:#fff;padding:18px;}
  .wrap{display:flex;gap:18px;align-items:flex-start;}
  .panel{background:#111827;padding:14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.4);}
  button{margin:6px 4px;padding:8px 12px;border-radius:6px;border:0;background:#1f2937;color:#fff;cursor:pointer;}
  button.big{padding:12px 18px;font-weight:700;}
  .large{font-size:24px;font-weight:700;margin-bottom:8px;}
  table{border-collapse:collapse;width:100%;}
  th,td{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:left;}
  .controls{display:flex;flex-wrap:wrap;gap:8px;}
  .export, .reset {background:#065f46;}
  .danger{background:#9b1c1c;}
  .positive{background:#065f46;}
  .neutral{background:#374151;}
  .info{background:#0ea5a4;}
  .history{max-height:420px;overflow:auto;background:#0b1220;padding:8px;border-radius:6px;}
/* スマホ・タブレット用 */
@media (max-width: 768px) {
  .wrap {
    flex-direction: column; /* 縦並びに切り替え */
  }
  .panel {
    width: 100% !important; /* スマホ幅に合わせる */
    margin-bottom: 12px;
  }
  .large {
    font-size: 20px; /* 見やすい大きさに */
  }
  button {
    width: 100%; /* ボタンは横幅いっぱい */
  }
  .controls {
    flex-direction: column;
    gap: 10px;
  }
}

</style>
</head>
<body>
  <h1>えんえんトンネル  延長距離シミュレーター</h1>
  <p>イベントをクリックすると「距離の増減」と「合計距離」が記録されます。</p>

  <div class="wrap">
    <div class="panel">
      <div class="large" id="totalDisplay">現在の推定延長距離: 0 m</div>

      <div class="controls">
        <!-- NPC系 -->
        <div>
          <div style="font-weight:700;margin-bottom:6px">NPC（移動+500m）</div>
          <button onclick="addEvent('しがないニワトリ',500)" class="positive">しがないニワトリ</button>
          <button onclick="addEvent('勝負する少年',500)" class="positive">勝負する少年</button>
          <button onclick="addEvent('哲学する小学生',500)" class="positive">哲学する小学生</button>
          <button onclick="addEvent('つかれる女',500)" class="positive">つかれる女</button>
          <button onclick="addEvent('こんがらがる男',500)" class="positive">こんがらがる男</button>
        </div>

        <!-- 特殊NPC -->
        <div>
          <div style="font-weight:700;margin:6px 0">特殊NPC</div>
          <button onclick="addEvent('トンネル作業員',600)" class="positive">トンネル作業員 (+600m)</button>
        </div>

        <!-- スイッチ系 -->
        <div>
          <div style="font-weight:700;margin:6px 0">危険なスイッチ</div>
          <button onclick="addEvent('スイッチ +3000',3000)" class="danger">+3000m</button>
          <button onclick="addEvent('スイッチ +1500',1500)" class="positive">+1500m</button>
          <button onclick="addEvent('スイッチ -1000',-1000)" class="info">-1000m</button>
          <button onclick="addEvent('スイッチ -2000',-2000)" class="danger">-2000m</button>
        </div>
      </div>

      <div style="margin-top:12px;">
        <button onclick="undoLast()" class="neutral">取り消し（最後の1件）</button>
        <button onclick="resetAll()" class="reset">リセット</button>
        <button onclick="exportCSV()" class="export">CSV出力</button>
      </div>
    </div>

    <div class="panel" style="width:320px;">
      <div style="font-weight:700;margin-bottom:8px">回数カウント</div>
      <table id="countTable">
        <thead><tr><th>イベント</th><th>回数</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="panel" style="width:420px;">
      <div style="font-weight:700;margin-bottom:8px">履歴（クリックで編集可能）</div>
      <div id="history" class="history"></div>
    </div>
  </div>

<script>
  const events = [];
  let total = 0;
  const counters = {};

  function addEvent(name, value){
    const now = new Date();
    total += value;
    const entry = {
      time: now.toLocaleTimeString(),
      name: name,
      delta: value,
      total: total
    };
    events.push(entry);

    // カウンタ更新
    counters[name] = (counters[name] || 0) + 1;

    render();
  }

  function render(){
    document.getElementById('totalDisplay').textContent = `現在の推定延長距離: ${total} m`;

    // 履歴描画
    const hist = document.getElementById('history');
    hist.innerHTML = '';
    for(let i = events.length -1; i >= 0; i--){
      const e = events[i];
      const div = document.createElement('div');
      div.style.padding='6px';
      div.style.borderBottom='1px solid rgba(255,255,255,0.04)';
      div.style.cursor='pointer';
      div.innerHTML = `<b>[${e.time}]</b> ${e.name} <span style="float:right">${e.delta >=0 ? '+'+e.delta : e.delta} m → ${e.total} m</span>`;
      div.onclick = ()=>{
        const newName = prompt('イベント名を編集', e.name);
        if(newName === null) return;
        const newDelta = parseInt(prompt('変化量（m）を入力（負の値も可）', e.delta),10);
        if(!isNaN(newDelta)){
          // カウンタ修正
          counters[e.name]--;
          if(counters[e.name] <=0) delete counters[e.name];

          e.name = newName;
          e.delta = newDelta;

          counters[newName] = (counters[newName] || 0) + 1;

          recalcTotal();
          render();
        }
      };
      hist.appendChild(div);
    }

    // カウントテーブル描画
    const tbody = document.querySelector('#countTable tbody');
    tbody.innerHTML = '';
    for(const [name,count] of Object.entries(counters)){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${name}</td><td>${count}</td>`;
      tbody.appendChild(tr);
    }
  }

  function recalcTotal(){
    total = 0;
    countersClear();
    for(let i=0;i<events.length;i++){
      total += events[i].delta;
      events[i].total = total;
      counters[events[i].name] = (counters[events[i].name] || 0) + 1;
    }
  }

  function countersClear(){
    for(const k in counters){ delete counters[k]; }
  }

  function undoLast(){
    if(events.length === 0) return alert('履歴がありません');
    const last = events.pop();
    counters[last.name]--;
    if(counters[last.name] <= 0) delete counters[last.name];
    recalcTotal();
    render();
  }

  function resetAll(){
    if(!confirm('リセットしていい？履歴が消えるよ')) return;
    events.length = 0;
    total = 0;
    countersClear();
    render();
  }

  function exportCSV(){
    if(events.length === 0) return alert('履歴がありません');
    const header = ['time','event','delta_m','total_m'];
    const rows = events.map(e => [e.time, e.name, e.delta, e.total]);
    const csv = [header].concat(rows).map(r=>r.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ennenn_history.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  render();
</script>
</body>
</html>
